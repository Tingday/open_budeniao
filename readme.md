<h1>优惠券省钱查询 ——一个全自动的淘宝客微信机器人</h1>
淘宝客微信公众号机器人，淘宝省钱神器助手。
<div style="color:#FF0000">关注微信公众号：<b>优惠券省钱查询</b>了解更多。</div>
<h1>框架要求</h1>
<h3>运行环境</h3>
<pre>
1.centos
2.python3以上
3.nginx
4.django    tengine + django + python + sqlite3
5.sqlite3 centos自带即可
</pre>
<h3>python框架</h3>
<pre>
aliyun-python-sdk-core        2.13.13
beautifulsoup4                4.8.2
Django                        1.11.27
pycryptodome                  3.9.4
pycurl                        7.19.0
pyflakes                      1.6.0
requests                      2.22.0
web.py                        0.40
topsdk                        这是通过某位开发者上传的支持python3的淘宝联盟sdk
</pre>
<h3>数据库结构</h3>
<pre>
采用了sqlite数据库，
.tables即可查看。
</pre>
<h1>以下为更新日志</h1>
  <h3>2022-07-15 增加了测试账号</h3>
<pre>
1.进一步优化代码；
2.添加了微信公众号的测试账号；
3.与时俱进，增加参数；
4.把wx_budeniao添加到了apps管理中；
5.并且连接了django中的数据库，为下一步更换sqlite3为django做准备；
6.调整了数据库的名称，需注意，在uwsgi运行时的数据库名称；
</pre>
  <h3>2022-06-25 更新</h3>
<pre>
1.修复部分bugs；
2.着重修改了公众号菜单绑定支付宝功能；
3.优化了部分程序结构。
4.通过sourcetree软件同步gitee上
</pre>
<h3>2021-03-09 更新</h3>
<pre>
1.日常更新；
2.增加了truetime.py reinclude.py update.py三个文件；
3.plugin文件夹中的tabaolinksql.db属于软连接。
</pre>
<h3>2021-03-05 修复部分bug</h3>
<pre>
1.修复了部分bug；
2.带来了部分bug;
3.目前已经比较稳定地使用python3 和 Django内核。
</pre>

<h3>2020-12-29 升级到django内核</h3>
<pre>
1.升级到django内核；
2.升级到Python3；
3.使用了topsdk的python库；
4.修改了一些逻辑；
5.修复了部分bugs;
6.创建了部分bugs.
</pre>
<h3>2020-12-19 准备更新内核至django 抛弃web.py</h3>
<pre>
1.准备更新内核至django 抛弃web.py
2.准备升级至python3 使用了topsdk
3.暴风雨来临之前的宁静，备份python2的最后版本
4.main.py上的部分功能已经迁移至django 目前尚未上传到github
5.此版本只保留了核心功能
</pre>
<h3>2020-03-29 增加了短信模板</h3>
<pre>
1.增加了几个阿里云的短信模板，可以在alibaba.py中查看具体信息。
2.优化了数据库连接，增加了部分短信提醒。
3.其它修改。
</pre>
<h3>2020-03-21 优化代码结构</h3>
<pre>
1.优化代码结构linksql.py，使用user_info_by_openid代替原来的sqltbk；
2.修改了伴随而来的大量改动；
3.改动了订单收录函数，统一rid和pid收录方式，放弃收录relation_id；
4.增加了几个测试函数的文件。
</pre>
<h3>2020-03-20 修复不能提现的bug</h3>
<pre>
1.当用户订单小于等于3时，将无法提现，这已经过时了；
2.增加了当月订单重新收录的程序，改动了一些文件；
3.完善了订单更新问题，解决了pid用户无法更新订单状态的漏洞；
4.其它内容改动。
</pre>
<h3>2020-03-19 修复新用户无法分配pid的bug</h3>
<pre>
1.修复新用户无法分配pid的bug；
2.修复alibaba.py中，网络出错未处理的漏洞；
3.优化代码结构，部分漏洞修复；
</pre>
<h3>2020-01-31 修复部分漏洞</h3>
<pre>
1.修复文件linksql中addorders的漏洞；
2.给数据库结构增加了weixin_user表，以保存微信公众号用户的相关数据；
3.优化代码结构，部分漏洞修复；
4.接下来重点是优化现有的数据库架构，以适配淘宝联盟新版接口返回值。
</pre>
<h3>2020-01-31 删除部分过时代码</h3>
<pre>
1.删除部分过时代码。
2.公众号名称由“不得鸟优惠券”更改为“优惠券省钱查询”。
</pre>
<h3>2019-10-02 bug fix</h3>
<pre>
1.修复部分bug
</pre>
<h3>2019-09-21 python3不稳定</h3>
<pre>
1.由于淘宝联盟sdk top中的代码在python3下运行有问题（也不排除我不会用python3），从而重新使用python2
2.2019-09-20昨天淘宝联盟sdk升级，因此重构了alimama.py下的代码，重新创建函数newOrders
3.由于这次改动较大，改动了包括ztk_update.py文件中的twenty函数，同时增加了getTwentyOrders getThreeHoursOrders updateTodayOrders等函数，详细的可以看github的文件改动
4.淘宝联盟sdk的本次升级总体是好的，目前订单收录的请求次数明显减少，有利于减轻服务器的负担，同时又降低了编程难度，减少了代码量。
5.由于最近工作忙，一直拖着没有升级sdk，导致昨天联盟下架旧版接口而不能正常运行，好在今天是周末，赶紧花了一个下午的时间把sdk给升级了。
6.修复bug
</pre>
<h3>2019-09-13 升级python3</h3>
<pre>
1.把代码通过python3 -m lib2to3 -h 升级到了python3
2.从阿里云重新下载top
3.优化部分代码
</pre>
<h3>2019-09-08 整理代码</h3>
<pre>
1.把web.py改为了https的模式，但是目前还有个thread bug未修复；
2.整理了一些代码，日志系统相对完善了，就是在手机上看比较费劲；
3.删除和移动一些文件到operations目录;
4.bug fix。
</pre>
<h3>2019-06-19 增加了订单重复收录系统reinclude.py</h3>
<pre>
1.增加了订单再次收录系统
2.修复了提现流程的bug，现在重复提现将会失败
3.修复部分bug，优化代码结构
</pre>
<h3>2019-06-06 日志系统bug fix</h3>
<pre>
1.解决日志系统重复记录的问题
</pre>
<h3>2019-06-02 重构日志系统</h3>
<pre>
1.重构日志系统为logger
2.修复部分bug
</pre>
<h3>2019-05-29 增加top</h3>
<pre>
1.淘宝top在订单查询和月订单更新上
2.把部分操作性函数移动到operations文件夹
3.添加slogger.py文件准备添加日志系统
4.部分bug修复。
5.吐槽一下折淘客api稳定性是真的差，果然免费的东西没好货。
</pre>

<h3>2019-05-22 修复bug</h3>
<pre>
1.修复部分bug
</pre>

<h3>2019-04-02 上线rid模式</h3>
<pre>
私域管理模式
1.用户首次使用提示绑定渠道。
2.使用淘口令进行渠道绑定。
3.用户通过淘口令备案完成之后，服务器轮讯备案列表，并添加新备案到服务器数据库beian中。同时绑定微信openid 
4.用户备案完成后，微信公众号通过主动发送消息提醒完成备案。
5.完成备案的用户下单时自动判断是否有渠道关系，如果有就使用渠道关系下单。
6.在订单收录时，优先考虑渠道关系收录。
7.如果用户完成了渠道会员备案，则自动释放已有的pid绑定关系。
</pre>


<h3>2019-03-11 更新违禁词</h3>
<pre>
1.为公众号添加违禁词过滤功能，用于保护公众号安全。
2.违禁词添加到bwords.txt中，一行一个违禁词。
3.修复部分bug。
违禁词项目仓库：
<a href="https://github.com/Tingday/banwords">https://github.com/Tingday/banwords</a>
</pre>

<h3>2019-03-08更新</h3>
<pre>
1.修改部分bug，优化代码。
2.增加折淘客api
3.python3准备中。
</pre>

<h3>2019-03-02更新</h3>
<pre>
1.修复多个商品同时下单时，母订单与子订单不一致导致订单无法查询的bug。
2.修复在输入订单号后返回的红包金额显示错误的bug。
3.发现尚未修复的漏洞：用户创建订单后延迟付款可能导致订单无法正常收录的问题。建议每天补录数据库，但如果用户隔天付款，将导致订单无法正常收录。
4.其他细节调整。
</pre>

<h3>2019-02-22更新</h3>
<pre>
1.增加订单追踪功能。可以在crontab中自主确定更新频率，直接调用uorder.py更新。
2.完善代码结构。
3.修复部分bug。
4.pidku增加到接近200个
5.把相关php等网页安排在wx.budeniao.net中，释放另一个服务器。
6.静待寒冬来临的黑夜。
</pre>

<h3>2019-02-14更新</h3>
<pre>
1.增加订单绑定失败条件，非本人订单返回错误信息。
2.完善提现流程，做到无需登录服务器即可处理。
通过服务器接收微信回复促发“completedtixian”，完成提现|openid|姓名。
3.完善update.py的日志输出。
4.更改“实付”的数据检索关键词为alipay_total_price。
5.根据《Python PEP8 编码规范 中文版》筹备代码重构。
</pre>


<h3>2019-02-13更新</h3>
<pre>
1.增加订单遗漏的方案。在200个粉丝之前把pid固定分配到每一个人，，超过该数量的粉丝之后通过短信通知开发者处理pid使用情况。
2.用户输入订单号后，促发主动获取“20分订单”并把订单入库，然后通过查询数据库返回用户输入的订单号信息，提示订单绑定成功。 
3.按分级返回客户的金额信息。
<s>4.建立活动，签到翻倍。</s>
5.由于订单查询接口只支持从时间查询订单，而不能直接从订单号查询订单，所以只能要求把订单数据全部下载到本地数据库。这就要求大量的订单查询接口点数。
6.申请“系统故障通知”短信模板
<s>7.申请“订单处理通知”短信模板</s>
8.完善订单跟踪函数，做到尽量实时跟踪已经绑定的用户订单。可以在crontab中加入每天完善执行本月的订单更新。1.完善订单更新函数updateorder。2.本月订单跟踪函数monthorder
订单跟踪主要跟踪以下方面：
pay_price
commission
<b>earning_time</b>
tk_status
click_time
以create_time为时间标准更新本月的订单
9.完善订单收入机制。用户下单的订单在最短请求数最少的情况下尽快收录进数据库。一方面引导用户主动输入订单号，从订单号促发订单收录机制并返回订单信息（已完成），另一方面在cron中每10分钟或者几分钟促发一次。(已完成)
</pre>

<h3>2019-01-26更新</h3>
<pre>
1.通过带参数openid的网页链接，提供绑定用户接口，然后POST到主程序web.py中。
方法：用户触发绑定事件时，通过普通消息下发带有用户openid的连接。用户通过该连接填写的提现信息，支付宝姓名等将直接绑定到用户user表中。从而实现提现信息的获取。
</pre>
